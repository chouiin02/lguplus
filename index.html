<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>아이폰 17 사전예약 페이지</title>

<link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />

<link rel="preload" as="image" href="https://placehold.co/600x600/000000/ffffff?text=iPhone+17+Black">
<link rel="preload" as="image" href="https://placehold.co/600x600/a3d1b8/000000?text=iPhone+17+Green">
<link rel="preload" as="image" href="https://placehold.co/600x600/f5d7e2/000000?text=iPhone+17+Pink">
<link rel="preload" as="image" href="https://placehold.co/600x600/a9cce2/000000?text=iPhone+17+Blue">
<link rel="preload" as="image" href="https://placehold.co/600x600/cdc8c5/000000?text=iPhone+17+Pro+Natural">
<link rel="preload" as="image" href="https://placehold.co/600x600/55728a/ffffff?text=iPhone+17+Pro+Blue">
<link rel="preload" as="image" href="https://placehold.co/600x600/fcf6f0/000000?text=iPhone+17+Pro+White">
<link rel="preload" as="image" href="https://placehold.co/600x600/424245/ffffff?text=iPhone+17+Pro+Black">

<style>
/* --- 기본 스타일 및 레이아웃 설정 --- */
body {
font-family: 'Pretendard', sans-serif;
line-height: 1.6;
margin: 0;
padding: 0;
color: #1d1d1f;
background: linear-gradient(135deg, #e6f7ff 0%, #d1e8ff 100%);
overflow-x: hidden;
touch-action: manipulation; /* [추가] 더블클릭 확대 방지 */
}

.container {
max-width: 1200px;
margin: 0 auto;
padding: 10px 20px 20px;
background-color: #fff;
box-shadow: 0 0 10px rgba(0, 0, 0, 0.05);
border-radius: 12px;
min-height: 100vh;
position: relative;
}

h1, h2, h3 {
color: #1a1a1a;
font-weight: 600;
}

/* --- 상단 헤더 (로고 및 메뉴 버튼) 스타일 --- */
.header {
text-align: center;
padding: 10px 0;
}

.header .logo img {
max-width: 120px;
height: auto;
vertical-align: middle;
}

.menu-button {
position: absolute;
top: 20px;
right: 20px;
background: none;
border: none;
cursor: pointer;
padding: 0;
z-index: 101;
width: 44px;
height: 44px;
display: flex;
align-items: center;
justify-content: center;
}
.menu-button svg {
width: 28px;
height: 28px;
fill: #1d1d1f;
}

/* --- 사이드 메뉴 스타일 --- */
.side-menu-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.4); z-index: 1000; }
.side-menu { position: fixed; top: 0; right: -300px; width: 280px; height: 100%; background-color: #fff; box-shadow: -2px 0 8px rgba(0, 0, 0, 0.1); z-index: 1001; transition: right 0.3s ease-out; padding-top: 60px; }
.side-menu.open { right: 0; }
.side-menu ul { list-style: none; padding: 0; margin: 0; }
.side-menu ul li a { display: block; padding: 15px 20px; color: #1d1d1f; text-decoration: none; border-bottom: 1px solid #eee; transition: background-color 0.2s; }
.side-menu ul li a:hover { background-color: #f5f5f7; }
.side-menu .close-button { position: absolute; top: 15px; right: 20px; background: none; border: none; font-size: 2em; cursor: pointer; color: #1d1d1f; }

/* --- 공통 버튼 스타일 --- */
.option-label { font-weight: bold; margin-right: 10px; line-height: 40px; vertical-align: middle; flex-shrink: 0; }
.option-buttons { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 8px; flex-grow: 1; }
.option-buttons .option-btn { padding: 12px 20px; border: 1px solid #ddd; border-radius: 8px; background-color: #f9f9f9; cursor: pointer; font-size: 0.9em; color: #1d1d1f; transition: background-color 0.2s, border-color 0.2s, color 0.2s; text-align: center; box-sizing: border-box; }
.option-buttons .option-btn.active, .discount-options .option-btn.active { background: linear-gradient(45deg, #4a90e2, #1b61b3); color: #fff; border: 1px solid transparent; box-shadow: 0 4px 8px rgba(0,0,0,0.2); font-weight: bold; border-radius: 8px; }

.plan-list .plan-item { padding: 15px; border: 1px solid #ddd; border-radius: 8px; background-color: #f9f9f9; cursor: pointer; transition: background-color 0.2s, border-color 0.2s; margin-bottom: 10px; }
.plan-list .plan-item.active { background-color: #e0f2ff; border-color: #4a90e2; }
.plan-list .plan-item h4 { margin: 0 0 5px 0; font-size: 1.1em; font-weight: bold; }
.plan-list .plan-item p { margin: 0; font-size: 0.9em; color: #666; }

.discount-options { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 20px; }
.discount-options .option-btn { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 110px; padding: 15px; border-radius: 8px; border: 1px solid #ddd; background-color: #f9f9f9; cursor: pointer; transition: background-color 0.2s, border-color 0.2s, color 0.2s; }
.discount-options .option-btn .discount-title { font-size: 1.3em; font-weight: bold; }
.total-discount-amount { display: block; margin-top: 8px; font-size: 1.1em; font-weight: 500; }
.option-btn.active .total-discount-amount { color: #fff; }

.purchase-options-section + .purchase-options-section { margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee; }

.product-info-section { display: flex; flex-direction: column; gap: 20px; padding-bottom: 20px; border-bottom: 1px solid #eee; }
.image-gallery { width: 100%; }
.image-gallery img { width: 100%; border-radius: 10px; }
.product-title { font-size: 2em; margin-bottom: 5px; }
.product-price { font-size: 1.5em; color: #1a1a1a; font-weight: 700; margin-bottom: 20px; }

.color-options, .model-options, .capacity-options, .installment-options { display: flex; align-items: center; margin-bottom: 15px; flex-wrap: wrap; }
.color-swatch-list { display: flex; flex-wrap: wrap; gap: 10px; }
.color-options .color-swatch { width: 40px; height: 40px; border-radius: 50%; border: 2px solid transparent; cursor: pointer; transition: border-color 0.3s; flex-shrink: 0; }
.color-options .color-swatch.active { border-color: #4a90e2; }

.final-price-box { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-top: 2px solid #eee; margin-top: 20px; flex-wrap: wrap; }
.total-price { font-size: 1.7em; font-weight: 700; color: #007aff; display: flex; align-items: baseline; white-space: nowrap; }

.customer-info-section .input-group, .address-input-group { display: flex; gap: 10px; margin-bottom: 10px; flex-direction: column; }
.customer-info-section .input-group input, .address-input-group input { flex-grow: 1; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 0.9em; }
.address-input-group button { padding: 10px 15px; border: 1px solid #ddd; border-radius: 8px; background-color: #f9f9f9; cursor: pointer; font-size: 0.9em; transition: background-color 0.2s; }
.address-input-group button:hover { background-color: #eee; }

.privacy-agreement-section { padding-top: 10px; }
.privacy-agreement-section h3 { font-size: 1.2em; font-weight: bold; margin-bottom: 5px; }
.privacy-agreement-section h3 .required { color: #ff3b30; }
.privacy-agreement-section .section-subtitle { font-size: 0.9em; color: #6e6e73; margin-top: 0; }
.privacy-info-box { background-color: #f5f5f7; border: 1px solid #e5e5ea; border-radius: 12px; padding: 20px; margin-top: 15px; }
.privacy-info-box .info-item + .info-item { margin-top: 15px; }
.privacy-info-box .info-label { display: block; font-size: 0.9em; color: #6e6e73; margin-bottom: 4px; }
.privacy-info-box .info-value { font-size: 1em; font-weight: 600; color: #1d1d1f; margin: 0; }
.agreement-checkbox { margin-top: 15px; }
.agreement-checkbox input[type="checkbox"] { display: none; }
.agreement-checkbox label { display: flex; align-items: center; justify-content: center; width: 100%; padding: 15px; border: 1px solid #ddd; border-radius: 12px; cursor: pointer; box-sizing: border-box; background-color: #f9f9f9; transition: background-color 0.2s, border-color 0.2s; }
.agreement-checkbox .check-icon { color: #ccc; margin-right: 8px; transition: color 0.2s; }
.agreement-checkbox input[type="checkbox"]:checked + label { border-color: #007aff; background-color: #fff; }
.agreement-checkbox input[type="checkbox"]:checked + label .check-icon { color: #007aff; }

.btn-purchase { width: 100%; padding: 20px; margin-top: 30px; background: linear-gradient(45deg, #4a90e2, #1b61b3); color: #fff; border: none; border-radius: 12px; font-size: 1.5em; font-weight: bold; cursor: pointer; box-shadow: 0 6px 12px rgba(0, 0, 0, 0.25); transition: all 0.2s; }
.btn-purchase:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3); }
.btn-purchase:disabled { background: #e5e5ea; color: #8e8e93; cursor: not-allowed; box-shadow: none; }

.fixed-buttons { position: fixed; bottom: 20px; right: 20px; z-index: 1000; }
.btn-fixed-call { display: flex; align-items: center; justify-content: center; background: linear-gradient(45deg, #4a90e2, #1b61b3); color: #fff; padding: 12px 20px; border-radius: 50px; text-decoration: none; font-weight: bold; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2); transition: all 0.3s ease; }
.btn-fixed-call:hover { transform: scale(1.05); box-shadow: 0 6px 16px rgba(0, 0, 0, 0.25); }
.btn-fixed-call .icon { display: flex; align-items: center; margin-right: 8px; }
.btn-fixed-call .icon svg { width: 20px; height: 20px; fill: #fff; }
.btn-fixed-call .text { white-space: nowrap; font-size: 0.95em; }

@media (max-width: 767px) {
.product-info-section, .model-options, .capacity-options, .color-options { flex-direction: column; }
.option-buttons { grid-template-columns: repeat(2, 1fr); }
.model-options, .capacity-options, .color-options { align-items: flex-start; }
.model-options .option-label, .capacity-options .option-label, .color-options .option-label { margin-bottom: 8px; }
.model-options .option-buttons, .capacity-options .option-buttons, .color-options .color-swatch-list { width: 100%; }
#capacityButtons { display: flex; overflow-x: auto; padding-bottom: 10px; -ms-overflow-style: none; scrollbar-width: none; }
#capacityButtons::-webkit-scrollbar { display: none; }
#capacityButtons .option-btn { flex: 0 0 auto; white-space: nowrap; }
#installmentOptions .option-btn[data-installment="lumpsum"] { grid-column: 1 / -1; }
.address-input-group button { width: 100%; margin-top: 10px; }
}

@media (min-width: 768px) {
.product-info-section { flex-direction: row; }
.image-gallery, .product-summary { flex: 1; }
.option-buttons { display: flex; flex-wrap: wrap; }
.option-buttons .option-btn { flex-grow: 1; min-width: fit-content; }
#capacityButtons { flex-wrap: nowrap; overflow-x: auto; }
.address-input-group { flex-direction: row; align-items: center; }
}

.custom-popup-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); backdrop-filter: blur(4px); z-index: 2000; justify-content: center; align-items: center; padding: 15px; box-sizing: border-box; overflow-y: auto; }
.custom-popup { background-color: #fff; padding: 25px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3); max-width: 90%; width: 400px; animation: fadeIn 0.3s ease-out; text-align: center; margin: auto; }
@keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
.popup-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px; }
.popup-buttons button:only-child { grid-column: 1 / -1; }
.popup-buttons button { padding: 12px; border: none; border-radius: 8px; font-size: 1em; font-weight: bold; cursor: pointer; }
.popup-buttons .popup-btn-cancel { background-color: #e5e5ea; color: #1d1d1f; }
.popup-buttons .popup-btn-confirm { background-color: #007aff; color: #fff; }

.popup-summary { text-align: left; font-size: 0.9em; background-color: #f9f9f9; padding: 15px; border-radius: 8px; margin: 15px 0; border: 1px solid #eee; }
.summary-item { display: grid; grid-template-columns: 80px 1fr; gap: 10px; padding: 8px 0; border-bottom: 1px solid #eee; }
.summary-item.header { grid-template-columns: 1fr; font-weight: bold; color: #007aff; padding-top: 10px; border-bottom: 1px solid #ccc; }
.summary-item:last-child { border-bottom: none; }
.summary-item .label { font-weight: bold; color: #555; }
.summary-item .value { color: #1d1d1f; word-break: keep-all; }
#popupMessage { text-align: center; }
</style>
</head>
<body>

<div class="container" id="preorderFormContainer">
<button class="menu-button" id="menuButton">
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 4H21V6H3V4ZM3 11H21V13H3V11ZM3 18H21V20H3V18Z"></path></svg>
</button>
<header class="header">
<div class="logo">
<a href="javascript:void(0);">
<img src="LOGO.png" alt="Company Logo">
</a>
</div>
</header>

<main class="product-detail-page">
<section class="product-info-section">
<div class="image-gallery"><img id="iphoneImage" src="https://placehold.co/600x600/ffffff/000000?text=iPhone+17" alt="iPhone 17"></div>
<div class="product-summary">
<div class="model-options"><span class="option-label">기종선택:</span><div class="option-buttons" id="modelButtons"><button class="option-btn" data-model="17">iPhone 17</button><button class="option-btn" data-model="air">iPhone 17 Air</button><button class="option-btn" data-model="pro">iPhone 17 Pro</button><button class="option-btn" data-model="promax">iPhone 17 Pro Max</button></div></div>
<div class="color-options" style="margin-top: 15px;"><span class="option-label">색상:</span><div id="colorSwatchContainer" class="color-swatch-list"></div></div>
<div class="capacity-options"><span class="option-label">용량선택:</span><div class="option-buttons" id="capacityButtons"></div></div>
<h1 class="product-title" id="productTitle"></h1>
<p class="product-price" id="productPrice"></p>
</div>
</section>

<section class="purchase-options-section">
<h2>가입 정보 및 요금제</h2>
<div class="option-group"><h3>가입 유형</h3><div class="option-buttons" id="subscriptionButtons"><button class="option-btn" id="btn-device-change" data-subscription="device-change">기기변경</button><button class="option-btn" id="btn-number-transfer" data-subscription="number-transfer">번호이동</button></div></div>
<div class="option-group">
<h3>요금제 선택</h3>
<div class="plan-list" id="planList">
<div class="plan-item" data-plan="super"><h4>(티빙) 5G 프리미어 슈퍼</h4><p>월 115,000원<span class="plan-text"> 선택약정 할인 신청시 81,000원</span></p></div>
<div class="plan-item" data-plan="essential"><h4>5G 프리미어 에센셜</h4><p>월 85,000원<span class="plan-text"> 선택약정 할인 신청시 58,500원</span></p></div>
<div class="plan-item" data-plan="light-plus"><h4>5G 라이트+</h4><p>월 55,000원<span class="plan-text"> 선택약정 할인 신청시 41,250원</span></p></div>
<div class="plan-item" data-plan="consult"><h4>나중에 상담하기</h4></div>
</div>
</div>
<div class="final-price-box"><div class="price-summary"><span class="price-summary-label">총 예상 금액(월) :</span><span class="total-price" id="monthlyPayment"></span></div></div>
</section>

<div class="discount-options" id="discountOptionsContainer">
<div class="consult-message" id="consultMessage" style="display:none">전문 상담사가 상담 도와드리겠습니다</div>
<button class="option-btn" id="discountBtnSelection" data-discount="selection"><span class="discount-title">선택약정 할인</span><span class="total-discount-amount" id="selectionTotalDiscountAmount"></span></button>
<button class="option-btn" id="discountBtnSupport" data-discount="support"><span class="discount-title">이통사 지원금</span><span class="total-discount-amount" id="supportTotalDiscountAmount"></span></button>
</div>

<section class="purchase-options-section">
<h3>기기 할부 선택</h3>
<div class="option-buttons" id="installmentOptions"><button class="option-btn" data-installment="lumpsum">일시납</button><button class="option-btn" data-installment="24">24개월</button><button class="option-btn" data-installment="36">36개월</button><button class="option-btn" data-installment="48">48개월</button><button class="option-btn" data-installment="later">추후 선택</button></div>
</section>

<section class="purchase-options-section">
<h3>제휴카드 할인 선택</h3>
<div class="option-buttons" id="cardDiscountOptions"><button class="option-btn" data-card-discount="consult">상담하기</button><button class="option-btn" data-card-discount="none">신청안함</button></div>
</section>

<section class="purchase-options-section">
<h2>배송 방법을 선택해 주세요</h2>
<div class="option-buttons" id="deliveryOptions"><button class="option-btn" data-delivery="courier">우체국 택배</button><button class="option-btn" data-delivery="quick">퀵 배송</button></div>
</section>

<section class="purchase-options-section customer-info-section">
<h2>고객 정보</h2>
<div class="input-group"><input type="text" id="customerName" placeholder="성함"></div>
<div class="input-group"><input type="tel" id="contactNumber" placeholder="연락처 (예: 010-1234-5678)"></div>
</section>

<section class="purchase-options-section address-search-section">
<h2>배송지 정보</h2>
<div class="address-input-group"><input type="text" id="postcode" placeholder="우편번호" readonly><button id="findAddressBtn">주소 검색</button></div>
<div class="address-input-group"><input type="text" id="address" placeholder="기본 주소" readonly></div>
<div class="address-input-group"><input type="text" id="extraAddress" placeholder="상세 주소 입력" ></div>
</section>

<section class="purchase-options-section privacy-agreement-section">
<h3><span class="required">*</span> 개인정보 수집 동의</h3>
<p class="section-subtitle">동의를 거부하실 수 있으나 사전예약 참여가 불가능합니다.</p>
<div class="privacy-info-box">
<div class="info-item"><span class="info-label">수집하는 주체</span><p class="info-value">(주)엘지유플러스</p></div>
<div class="info-item"><span class="info-label">수집하는 개인정보 항목</span><p class="info-value">이름, 연락처, 주소</p></div>
<div class="info-item"><span class="info-label">수집 및 이용 목적</span><p class="info-value">예약내역 확인 및 상담</p></div>
<div class="info-item"><span class="info-label">보유 및 이용기간</span><p class="info-value">예약신청후 개통 및 취소 후 일주일</p></div>
</div>
<div class="agreement-checkbox">
<input type="checkbox" id="privacyAgree" name="privacyAgree">
<label for="privacyAgree">
<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="check-icon"><path d="M20 6L9 17L4 12" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
<span>개인정보 수집 및 이용에 동의합니다.</span>
</label>
</div>
</section>

<button class="btn-purchase" id="purchaseButton">즉시 예약</button>
</main>
</div>

<div class="fixed-buttons">
<a href="tel:010-8081-6900" class="btn-fixed-call">
<span class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M6.62 10.79C8.06 13.62 10.38 15.94 13.21 17.38L15.41 15.18C15.69 14.9 16.08 14.82 16.43 14.93C17.55 15.3 18.75 15.5 20 15.5C20.55 15.5 21 15.95 21 16.5V20C21 20.55 20.55 21 20 21C10.61 21 3 13.39 3 4C3 3.45 3.45 3 4 3H7.5C8.05 3 8.5 3.45 8.5 4C8.5 5.25 8.7 6.45 9.07 7.57C9.18 7.92 9.1 8.31 8.82 8.59L6.62 10.79Z"></path></svg></span>
<span class="text">상담사 연결</span>
</a>
</div>

<div class="custom-popup-overlay" id="customPopup"><div class="custom-popup"><h3 id="popupTitle">알림</h3><div id="popupMessageContainer"></div><div class="popup-buttons" id="popupButtonsContainer"></div></div></div>
<div class="side-menu-overlay" id="sideMenuOverlay"></div>

<div class="side-menu" id="sideMenu"><button class="close-button" id="closeMenuButton">&times;</button><ul><li><a href="order-check.html">주문내역</a></li><li><a href="admin.html">회사 소개</a></li></ul></div>

<script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
<script>
// --- 데이터 ---
const selections = { model: null, capacity: null, color: null, subscription: null, plan: null, discount: null, installment: null, cardDiscount: null, delivery: null };
const DISTRIBUTOR_DISCOUNT = 400000, SUPPORT_DISCOUNT = 450000, MONTHLY_INTEREST_RATE = 0.059 / 12;
const CAPACITIES_STANDARD = ['128GB', '256GB', '512GB'], CAPACITIES_PRO = ['256GB', '512GB', '1TB'];
const priceData = { '17':{ '128GB':1243000,'256GB':1397000,'512GB':1694000},'air':{ '128GB':1342000,'256GB':1496000,'512GB':1793000},'pro':{ '256GB':1694000,'512GB':1991000,'1TB':2299000},'promax':{ '256GB':1892000,'512GB':2200000,'1TB':2497000}};
const colorPalettes = { standard:[{id:'black',name:'블랙',code:'#1c1c1e',imageUrl:'https://placehold.co/600x600/000000/ffffff?text=iPhone+17+Black'},{id:'green',name:'그린',code:'#a3d1b8',imageUrl:'https://placehold.co/600x600/a3d1b8/000000?text=iPhone+17+Green'},{id:'pink',name:'핑크',code:'#f5d7e2',imageUrl:'https://placehold.co/600x600/f5d7e2/000000?text=iPhone+17+Pink'},{id:'blue',name:'블루',code:'#a9cce2',imageUrl:'https://placehold.co/600x600/a9cce2/000000?text=iPhone+17+Blue'}],pro:[{id:'natural',name:'네츄럴 티타늄',code:'#cdc8c5',imageUrl:'https://placehold.co/600x600/cdc8c5/000000?text=iPhone+17+Pro+Natural'},{id:'blue',name:'블루 티타늄',code:'#55728a',imageUrl:'https://placehold.co/600x600/55728a/ffffff?text=iPhone+17+Pro+Blue'},{id:'white',name:'화이트 티타늄',code:'#fcf6f0',imageUrl:'https://placehold.co/600x600/fcf6f0/000000?text=iPhone+17+Pro+White'},{id:'black',name:'블랙 티타늄',code:'#424245',imageUrl:'https://placehold.co/600x600/424245/ffffff?text=iPhone+17+Pro+Black'}]};

// --- DOM 요소 ---
const modelButtons = document.querySelectorAll('#modelButtons .option-btn'), capacityButtonsContainer = document.getElementById('capacityButtons'), colorSwatchContainer = document.getElementById('colorSwatchContainer'), subscriptionButtons = document.querySelectorAll('#subscriptionButtons .option-btn'), planItems = document.querySelectorAll('#planList .plan-item'), discountButtons = document.querySelectorAll('#discountOptionsContainer .option-btn'), installmentOptionButtons = document.querySelectorAll('#installmentOptions .option-btn'), deliveryOptionButtons = document.querySelectorAll('#deliveryOptions .option-btn'), productTitle = document.getElementById('productTitle'), productPrice = document.getElementById('productPrice'), monthlyPaymentSpan = document.getElementById('monthlyPayment'), consultMessage = document.getElementById('consultMessage'), customerNameField = document.getElementById('customerName'), contactNumberField = document.getElementById('contactNumber'), postcodeField = document.getElementById('postcode'), addressField = document.getElementById('address'), extraAddressField = document.getElementById('extraAddress'), customPopup = document.getElementById('customPopup'), popupTitle = document.getElementById('popupTitle'), popupMessageContainer = document.getElementById('popupMessageContainer'), popupButtonsContainer = document.getElementById('popupButtonsContainer'), iphoneImage = document.getElementById('iphoneImage'), selectionTotalDiscountAmount = document.getElementById('selectionTotalDiscountAmount'), supportTotalDiscountAmount = document.getElementById('supportTotalDiscountAmount'), menuButton = document.getElementById('menuButton'), sideMenu = document.getElementById('sideMenu'), closeMenuButton = document.getElementById('closeMenuButton'), sideMenuOverlay = document.getElementById('sideMenuOverlay'), privacyAgreeCheckbox = document.getElementById('privacyAgree'), purchaseButton = document.getElementById('purchaseButton'), cardDiscountOptionButtons = document.querySelectorAll('#cardDiscountOptions .option-btn');

function showPopup(content, title = '알림', buttons = [{ text: '확인' }]) {
popupTitle.textContent = title; popupMessageContainer.innerHTML = content; popupButtonsContainer.innerHTML = '';
buttons.forEach(buttonInfo => { const button = document.createElement('button'); button.textContent = buttonInfo.text; button.className = `popup-btn-${buttonInfo.type || 'confirm'}`; button.onclick = () => { customPopup.style.display = 'none'; if (buttonInfo.action) buttonInfo.action(); }; popupButtonsContainer.appendChild(button); });
customPopup.style.display = 'flex';
}

function generateSummaryHTML() {
const getActiveText = (selector) => { const element = document.querySelector(`${selector}.active`); if (!element) return '선택 안함'; if (element.querySelector('h4')) return element.querySelector('h4').textContent; return element.textContent.trim(); };
const selectedColorInfo = colorPalettes.standard.concat(colorPalettes.pro).find(c => c.id === selections.color);
const selectedColorName = selectedColorInfo ? selectedColorInfo.name : '선택 안함';
let activeDiscountBtn = document.querySelector('#discountOptionsContainer .option-btn.active');
let discountType = '상담 후 결정';
if(activeDiscountBtn && selections.plan !== 'consult'){ const title = activeDiscountBtn.querySelector('.discount-title').textContent; const amount = activeDiscountBtn.querySelector('.total-discount-amount').textContent; discountType = `${title} (${amount})`; }
let summaryHtml = `<div class="popup-summary"><div class="summary-item"><span class="label">기종/용량</span><span class="value">${productTitle.textContent}</span></div><div class="summary-item"><span class="label">색상</span><span class="value">${selectedColorName}</span></div><div class="summary-item"><span class="label">가입 유형</span><span class="value">${getActiveText('#subscriptionButtons .option-btn')}</span></div><div class="summary-item"><span class="label">요금제</span><span class="value">${getActiveText('#planList .plan-item')}</span></div>`;
if (selections.plan !== 'consult') { summaryHtml += `<div class="summary-item"><span class="label">할인 유형</span><span class="value">${discountType}</span></div>`; if (selections.subscription === 'number-transfer') { summaryHtml += `<div class="summary-item"><span class="label">추가 지원</span><span class="value">유통망 지원금</span></div>`; } }
summaryHtml += `<div class="summary-item"><span class="label">할부</span><span class="value">${getActiveText('#installmentOptions .option-btn')}</span></div><div class="summary-item"><span class="label">제휴카드</span><span class="value">${getActiveText('#cardDiscountOptions .option-btn')}</span></div><div class="summary-item"><span class="label">배송 방법</span><span class="value">${getActiveText('#deliveryOptions .option-btn')}</span></div><div class="summary-item header"><span class="value">신청자 정보</span></div><div class="summary-item"><span class="label">성함</span><span class="value">${customerNameField.value}</span></div><div class="summary-item"><span class="label">연락처</span><span class="value">${contactNumberField.value}</span></div><div class="summary-item"><span class="label">배송지</span><span class="value">[${postcodeField.value}] ${addressField.value} ${extraAddressField.value}</span></div></div><p id="popupMessage">위 내용으로 신청서를 제출하시겠습니까?</p>`;
return summaryHtml;
}

function handlePreorderClick() {
const validationError = validateForm();
if (validationError) { showPopup(`<p>${validationError}</p>`); return; }
showPopup(generateSummaryHTML(), '신청 내용 확인', [{ text: '수정하기', type: 'cancel' }, { text: '제출하기', type: 'confirm', action: submitApplication }]);
}

function generateUniqueId() {
    const randomNumber = Math.floor(Math.random() * 100000);
    return 100000 + randomNumber;
}

// --- [수정] 서버와 연동하는 submitApplication 함수 ---
async function submitApplication() {
    const uniqueId = generateUniqueId();

    // 서버로 보낼 전체 데이터 구성
    const submissionData = {
        orderNumber: uniqueId,
        customerName: customerNameField.value,
        contactNumber: contactNumberField.value,
        model: selections.model ? document.querySelector(`#modelButtons .option-btn[data-model="${selections.model}"]`).textContent.trim() : '',
        color: selections.color ? (colorPalettes.standard.concat(colorPalettes.pro).find(c => c.id === selections.color).name) : '',
        capacity: selections.capacity,
        plan: selections.plan ? document.querySelector(`#planList .plan-item[data-plan="${selections.plan}"] h4`).textContent : '나중에 상담하기',
        submissionDate: new Date().toISOString().split('T')[0] // YYYY-MM-DD 형식
    };

    try {
        // 가상의 서버 주소 '/api/preorder'로 데이터를 POST 방식으로 전송
        const response = await fetch('/api/preorder', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(submissionData)
        });

        // 서버에서 응답이 성공적으로 오면 (실제 서버에서는 200, 201 등)
        if (response.ok) {
            const successMessage = `
                <p>성공적으로 예약 정보가 제출되었습니다.<br>전문 상담원이 빠른 시일 내에 연락드리겠습니다.</p>
                <div style="margin-top: 15px; padding: 10px; background-color: #f0f0f0; border-radius: 8px;">
                    <strong>예약번호: ${uniqueId}</strong>
                </div>
            `;
            showPopup(successMessage, '예약 완료');
        } else {
            // 서버에서 오류 응답이 오면
            showPopup('<p>예약 제출에 실패했습니다. 잠시 후 다시 시도해 주세요.</p>', '오류');
        }
    } catch (error) {
        // 네트워크 오류 등 fetch 자체가 실패하면
        console.error('Submission Error:', error);
        showPopup('<p>서버와 통신 중 오류가 발생했습니다. 관리자에게 문의해 주세요.</p>', '오류');
    }
}


function validateForm() {
if (!selections.model) return '기종을 선택해 주세요.'; if (!selections.capacity) return '용량을 선택해 주세요.'; if (!selections.color) return '색상을 선택해 주세요.'; if (!selections.subscription) return '가입 유형을 선택해 주세요.'; if (!selections.plan) return '요금제를 선택해 주세요.'; if (selections.plan !== 'consult' && !selections.discount) return '할인 유형을 선택해 주세요.'; if (!selections.installment) return '할부 개월을 선택해 주세요.'; if (!selections.cardDiscount) return '제휴카드 할인 여부를 선택해 주세요.'; if (!selections.delivery) return '배송 방법을 선택해 주세요.'; if (!customerNameField.value.trim()) return '성함을 입력해 주세요.'; if (!contactNumberField.value.trim()) return '연락처를 입력해 주세요.'; if (!postcodeField.value || !addressField.value) return '배송지 정보를 입력해 주세요.'; if (!privacyAgreeCheckbox.checked) return '개인정보 수집 및 이용에 동의해야 합니다.';
return null;
}

function formatCurrency(amount) { return (amount || 0).toLocaleString('ko-KR') + '원'; }
function updateAllUI() {
if (!selections.model || !selections.capacity) { productTitle.textContent = '아이폰 17'; productPrice.textContent = '가격을 확인하려면 기종과 용량을 선택하세요'; monthlyPaymentSpan.innerHTML = '옵션을 선택하세요'; return; }
const modelKey = selections.model, capacity = selections.capacity, price = priceData[modelKey]?.[capacity];
let displayModel = modelKey.toUpperCase().replace('PROMAX', 'Pro Max').replace('PRO', 'Pro');
if (displayModel === '17') displayModel = 'iPhone 17'; else if (displayModel === 'AIR') displayModel = 'iPhone 17 Air'; else displayModel = `iPhone 17 ${displayModel}`;
productTitle.textContent = `${displayModel} (${capacity})`; productPrice.textContent = formatCurrency(price); updateDiscountUI(); calculateMonthlyPayment();
}

function updateDiscountUI() {
if (!selections.plan) return;
const isNumberTransfer = selections.subscription === 'number-transfer';
let selectionBaseDiscount;
if (selections.plan === 'super') { selectionBaseDiscount = 690000; }
else if (selections.plan === 'essential') { selectionBaseDiscount = 510000; }
else if (selections.plan === 'light-plus') { selectionBaseDiscount = 330000; }
const totalSelectionDiscount = selectionBaseDiscount + (isNumberTransfer ? DISTRIBUTOR_DISCOUNT : 0);
selectionTotalDiscountAmount.textContent = `총 할인 ${formatCurrency(totalSelectionDiscount)}`;
const totalSupportDiscount = SUPPORT_DISCOUNT + (isNumberTransfer ? DISTRIBUTOR_DISCOUNT : 0);
supportTotalDiscountAmount.textContent = `총 할인 ${formatCurrency(totalSupportDiscount)}`;
}

function calculateMonthlyPayment() {
if (!selections.capacity || !selections.model || !selections.installment || !priceData[selections.model]?.[selections.capacity]) { monthlyPaymentSpan.innerHTML = '옵션을 선택하세요'; return; }
let devicePrice = priceData[selections.model][selections.capacity];
if (selections.plan === 'consult') { monthlyPaymentSpan.innerHTML = '요금 상담 필요'; return; }
if (selections.installment === 'lumpsum' || selections.installment === 'later') { monthlyPaymentSpan.innerHTML = `할부금 0원<span class="monthly-fee-label">+ 요금</span>`; return; }
let finalPrice = devicePrice;
if (selections.discount === 'support') finalPrice -= SUPPORT_DISCOUNT;
if (selections.subscription === 'number-transfer') finalPrice -= DISTRIBUTOR_DISCOUNT;
if (finalPrice < 0) finalPrice = 0;
const n = parseInt(selections.installment, 10), r = MONTHLY_INTEREST_RATE;
let monthlyPayment = r === 0 ? finalPrice / n : (finalPrice * r * Math.pow(1 + r, n)) / (Math.pow(1 + r, n) - 1);
monthlyPaymentSpan.innerHTML = `할부금 ${formatCurrency(Math.floor(monthlyPayment / 10) * 10)}<span class="monthly-fee-label">+ 요금</span>`;
}

function createCapacityButtons(capacities) {
capacityButtonsContainer.innerHTML = '';
capacities.forEach(capacity => { const button = document.createElement('button'); button.className = 'option-btn'; button.textContent = capacity; button.dataset.capacity = capacity; button.addEventListener('click', () => { capacityButtonsContainer.querySelectorAll('.option-btn').forEach(btn => btn.classList.remove('active')); button.classList.add('active'); selections.capacity = capacity; updateAllUI(); }); capacityButtonsContainer.appendChild(button); });
}

function updateColorSwatches(paletteType) {
const palette = colorPalettes[paletteType];
colorSwatchContainer.innerHTML = '';
palette.forEach(color => { const button = document.createElement('button'); button.className = 'color-swatch'; button.dataset.color = color.id; button.style.backgroundColor = color.code; button.setAttribute('aria-label', color.name); button.addEventListener('click', () => { colorSwatchContainer.querySelectorAll('.color-swatch').forEach(btn => btn.classList.remove('active')); button.classList.add('active'); selections.color = color.id; iphoneImage.src = color.imageUrl; }); colorSwatchContainer.appendChild(button); });
}

function setupEventListeners() {
purchaseButton.addEventListener('click', handlePreorderClick);
modelButtons.forEach(button => { button.addEventListener('click', () => { modelButtons.forEach(btn => btn.classList.remove('active')); button.classList.add('active'); selections.model = button.dataset.model; const isPro = ['pro', 'promax'].includes(selections.model); createCapacityButtons(isPro ? CAPACITIES_PRO : CAPACITIES_STANDARD); updateColorSwatches(isPro ? 'pro' : 'standard'); const firstCapacityBtn = capacityButtonsContainer.querySelector('.option-btn:first-child'); if (firstCapacityBtn) firstCapacityBtn.click(); const firstColorBtn = colorSwatchContainer.querySelector('.color-swatch:first-child'); if(firstColorBtn) firstColorBtn.click(); updateAllUI(); }); });
subscriptionButtons.forEach(button => { button.addEventListener('click', () => { subscriptionButtons.forEach(btn => btn.classList.remove('active')); button.classList.add('active'); selections.subscription = button.dataset.subscription; updateDiscountUI(); calculateMonthlyPayment(); }); });
planItems.forEach(item => { item.addEventListener('click', () => { planItems.forEach(plan => plan.classList.remove('active')); item.classList.add('active'); selections.plan = item.dataset.plan; if (selections.plan === 'consult') { discountButtons.forEach(btn => btn.style.display = 'none'); consultMessage.style.display = 'block'; installmentOptionButtons.forEach(btn => { if(btn.dataset.installment === 'later') btn.click(); }); } else { discountButtons.forEach(btn => btn.style.display = 'flex'); consultMessage.style.display = 'none'; } updateAllUI(); }); });
discountButtons.forEach(button => { button.addEventListener('click', () => { discountButtons.forEach(btn => btn.classList.remove('active')); button.classList.add('active'); selections.discount = button.dataset.discount; calculateMonthlyPayment(); }); });
installmentOptionButtons.forEach(button => { button.addEventListener('click', () => { installmentOptionButtons.forEach(btn => btn.classList.remove('active')); button.classList.add('active'); selections.installment = button.dataset.installment; calculateMonthlyPayment(); }); });
cardDiscountOptionButtons.forEach(button => { button.addEventListener('click', () => { cardDiscountOptionButtons.forEach(btn => btn.classList.remove('active')); button.classList.add('active'); selections.cardDiscount = button.dataset.cardDiscount; }); });
deliveryOptionButtons.forEach(button => { button.addEventListener('click', () => { deliveryOptionButtons.forEach(btn => btn.classList.remove('active')); button.classList.add('active'); selections.delivery = button.dataset.delivery; }); });
document.getElementById('findAddressBtn').addEventListener('click', () => { new daum.Postcode({ oncomplete: data => { postcodeField.value = data.zonecode; addressField.value = data.roadAddress; extraAddressField.focus(); } }).open(); });
menuButton.addEventListener('click', () => { sideMenu.classList.add('open'); sideMenuOverlay.style.display = 'block'; });
closeMenuButton.addEventListener('click', () => { sideMenu.classList.remove('open'); sideMenuOverlay.style.display = 'none'; });
sideMenuOverlay.addEventListener('click', () => { sideMenu.classList.remove('open'); sideMenuOverlay.style.display = 'none'; });
privacyAgreeCheckbox.addEventListener('change', () => { purchaseButton.disabled = !privacyAgreeCheckbox.checked; });
}

function initializePage() {
setupEventListeners();
purchaseButton.disabled = true;
document.querySelector('#modelButtons .option-btn[data-model="17"]').click();
document.getElementById('btn-device-change').click();
document.querySelector('#planList .plan-item[data-plan="super"]').click();
document.querySelector('#discountBtnSupport').click();
document.querySelector('#installmentOptions .option-btn[data-installment="later"]').click();
document.querySelector('#cardDiscountOptions .option-btn[data-card-discount="none"]').click();
document.querySelector('#deliveryOptions .option-btn[data-delivery="courier"]').click();
}

document.addEventListener('DOMContentLoaded', initializePage);
</script>
</body>
</html>
